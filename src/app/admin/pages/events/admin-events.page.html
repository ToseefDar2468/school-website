<div class="space-y-6">
  @if (vm$ | async; as vm) {
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-emerald-400">Events</p>
        <h1 class="text-2xl font-semibold text-white">School Events</h1>
        <p class="mt-1 text-sm text-slate-400">Manage upcoming programs and announcements.</p>
      </div>
      <button
        type="button"
        class="inline-flex items-center justify-center rounded-full bg-emerald-500 px-5 py-2 text-sm font-semibold text-slate-950 transition hover:bg-emerald-400"
        (click)="openCreate()"
      >
        Create Event
      </button>
    </div>

    @if (vm.errorMessage) {
      <div class="rounded-2xl border border-rose-500/40 bg-rose-500/10 px-4 py-3 text-sm text-rose-100">
        {{ vm.errorMessage }}
      </div>
    }

    @if (vm.isLoading) {
      <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-8 text-center text-sm text-slate-300">
        Loading events...
      </div>
    } @else {
      @if (vm.events.length) {
        <div class="overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/60">
        <div
            class="grid grid-cols-[2.1fr_1fr_1.2fr_1fr] gap-4 border-b border-slate-800 bg-slate-950/70 px-6 py-4 text-xs uppercase tracking-[0.25em] text-slate-500"
          >
            <span>Title</span>
            <span>Date</span>
            <span>Venue</span>
            <span>Actions</span>
          </div>

          @for (event of vm.events; track event.id) {
            <div
              class="grid grid-cols-[2.1fr_1fr_1.2fr_1fr] gap-4 border-b border-slate-800 px-6 py-4 text-sm text-slate-300 last:border-b-0"
            >
              <div>
                <p class="font-semibold text-white">{{ event.title }}</p>
                <p class="mt-1 text-xs text-slate-500">{{ event.description }}</p>
              </div>
              <div class="text-slate-400">{{ event.dateISO | date: 'mediumDate' }}</div>
              <div class="text-slate-200">{{ event.venue }}</div>
              <div class="flex flex-wrap items-center gap-2">
                <button
                  type="button"
                  class="rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-200 hover:border-slate-500"
                  (click)="openEdit(event)"
                >
                  Edit
                </button>
                <button
                  type="button"
                  class="rounded-full border border-rose-500/40 px-3 py-1 text-xs font-semibold text-rose-200 hover:border-rose-400"
                  [disabled]="vm.isDeleting && vm.deleteTarget?.id === event.id"
                  (click)="openDelete(event)"
                >
                  {{ vm.isDeleting && vm.deleteTarget?.id === event.id ? 'Deleting...' : 'Delete' }}
                </button>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="rounded-3xl border border-dashed border-slate-700 bg-slate-900/40 p-10 text-center">
          <p class="text-sm text-slate-300">No events yet.</p>
          <p class="mt-2 text-xs text-slate-500">Create the first event to get started.</p>
        </div>
      }
    }

    <app-admin-modal
      [open]="vm.formOpen"
      [title]="vm.editingEvent ? 'Edit Event' : 'Create Event'"
      [subtitle]="vm.editingEvent ? 'Update the event details.' : 'Publish a new event.'"
      (closed)="closeForm()"
    >
      <form class="space-y-4" [formGroup]="form" (ngSubmit)="submit()">
        <div class="space-y-2">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Title</label>
          <input
            type="text"
            class="w-full rounded-xl border border-slate-700 bg-slate-950 px-4 py-3 text-sm text-white placeholder:text-slate-600 focus:border-emerald-400 focus:outline-none"
            placeholder="Event title"
            formControlName="title"
          />
          @if (form.controls.title.touched && form.controls.title.invalid) {
            <p class="text-xs text-rose-300">Title is required.</p>
          }
        </div>

        <div class="space-y-2">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Description</label>
          <textarea
            rows="4"
            class="w-full rounded-xl border border-slate-700 bg-slate-950 px-4 py-3 text-sm text-white placeholder:text-slate-600 focus:border-emerald-400 focus:outline-none"
            placeholder="Write the event details..."
            formControlName="description"
          ></textarea>
          @if (form.controls.description.touched && form.controls.description.invalid) {
            <p class="text-xs text-rose-300">Description is required.</p>
          }
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Date</label>
            <input
              type="date"
              class="w-full rounded-xl border border-slate-700 bg-slate-950 px-4 py-3 text-sm text-white focus:border-emerald-400 focus:outline-none"
              formControlName="dateISO"
            />
            @if (form.controls.dateISO.touched && form.controls.dateISO.invalid) {
              <p class="text-xs text-rose-300">Date is required.</p>
            }
          </div>

          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Venue</label>
            <input
              type="text"
              class="w-full rounded-xl border border-slate-700 bg-slate-950 px-4 py-3 text-sm text-white placeholder:text-slate-600 focus:border-emerald-400 focus:outline-none"
              placeholder="Main auditorium"
              formControlName="venue"
            />
            @if (form.controls.venue.touched && form.controls.venue.invalid) {
              <p class="text-xs text-rose-300">Venue is required.</p>
            }
          </div>
        </div>

        <div class="space-y-2">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Cover Image URL</label>
          <input
            type="url"
            class="w-full rounded-xl border border-slate-700 bg-slate-950 px-4 py-3 text-sm text-white placeholder:text-slate-600 focus:border-emerald-400 focus:outline-none"
            placeholder="https://"
            formControlName="coverImageUrl"
          />
          @if (form.controls.coverImageUrl.touched && form.controls.coverImageUrl.invalid) {
            <p class="text-xs text-rose-300">Cover image URL is required.</p>
          }
        </div>

        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Gallery Image URLs</label>
            <button
              type="button"
              class="rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-200 hover:border-slate-500"
              (click)="addGalleryUrl()"
            >
              Add URL
            </button>
          </div>

          <div class="space-y-3">
            @for (control of galleryControls; track $index) {
              <div class="flex items-center gap-3">
                <input
                  type="url"
                  class="w-full rounded-xl border border-slate-700 bg-slate-950 px-4 py-3 text-sm text-white placeholder:text-slate-600 focus:border-emerald-400 focus:outline-none"
                  placeholder="https://"
                  [formControl]="control"
                />
                <button
                  type="button"
                  class="rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-200 hover:border-slate-500"
                  (click)="removeGalleryUrl($index)"
                >
                  Remove
                </button>
              </div>
            }
          </div>
        </div>

        <div class="flex flex-wrap items-center justify-end gap-3">
          <button
            type="button"
            class="rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold text-slate-200 hover:border-slate-500"
            (click)="closeForm()"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="rounded-full bg-emerald-500 px-5 py-2 text-xs font-semibold text-slate-950 transition hover:bg-emerald-400 disabled:cursor-not-allowed disabled:opacity-60"
            [disabled]="vm.isSaving"
          >
            {{ vm.isSaving ? 'Saving...' : vm.editingEvent ? 'Update Event' : 'Create Event' }}
          </button>
        </div>
      </form>
    </app-admin-modal>

  }
</div>
